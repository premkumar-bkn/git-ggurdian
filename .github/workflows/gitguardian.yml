# # # name: GitGuardian Secret Scan

# # # on:
# # #   push:
# # #     branches: [main]
# # #   pull_request:
# # #     branches: [main]

# # # jobs:
# # #   secret-scan:
# # #     runs-on: ubuntu-latest

# # #     steps:
# # #       - name: Checkout code
# # #         uses: actions/checkout@v3

# # #       - name: Set up Python
# # #         uses: actions/setup-python@v5
# # #         with:
# # #           python-version: '3.11'

# # #       - name: Install GitGuardian CLI
# # #         run: pip install ggshield

# # #       - name: Run GitGuardian Scan
# # #         env:
# # #           GITGUARDIAN_API_KEY: ${{ secrets.GG_API_KEY }}
# # #         run: ggshield secret scan ci

# # name: GitGuardian Secret Scan

# # on:
# #   push:
# #     branches: [main]
# #   pull_request:
# #     branches: [main]

# # jobs:
# #   secret-scan:
# #     runs-on: ubuntu-latest
# #     if: github.event_name == 'pull_request'

# #     steps:
# #       - name: Checkout code
# #         uses: actions/checkout@v3

# #       - name: Set up Python
# #         uses: actions/setup-python@v5
# #         with:
# #           python-version: '3.11'

# #       - name: Install GitGuardian CLI
# #         run: pip install ggshield

# #       - name: Run GitGuardian and handle result
# #         env:
# #           GITGUARDIAN_API_KEY: ${{ secrets.GG_API_KEY }}
# #           GH_TOKEN: ${{ secrets.GH_TOKEN }}
# #         run: |
# #           set -o pipefail
# #           output=$(ggshield secret scan ci 2>&1 || true)

# #           echo "$output"

# #           if echo "$output" | grep -q "Policy Break"; then
# #             # Post comment to PR
# #             body="üö® **GitGuardian Secret Scan Failed** üö®

# #             \`\`\`
# #             $output
# #             \`\`\`

# #             Please remove the detected secrets from your code or follow secure handling practices."

# #             pr_number=${{ github.event.pull_request.number }}

# #             curl -s -X POST \
# #               -H "Authorization: Bearer $GH_TOKEN" \
# #               -H "Content-Type: application/json" \
# #               -d "{\"body\": \"$body\"}" \
# #               "https://api.github.com/repos/${{ github.repository }}/issues/$pr_number/comments"

# #             echo "‚ùå Secrets detected. Failing the job."
# #             exit 1
# #           else
# #             echo "‚úÖ No secrets detected."
# #           fi


# name: GitGuardian Secret Scan

# on:
#   push:
#     branches: [main]
#   pull_request:
#     branches: [main]

# jobs:
#   secret-scan:
#     runs-on: ubuntu-latest
#     if: github.event_name == 'pull_request'

#     steps:
#       - name: Checkout code
#         uses: actions/checkout@v3

#       - name: Set up Python
#         uses: actions/setup-python@v5
#         with:
#           python-version: '3.11'

#       - name: Install GitGuardian CLI
#         run: pip install ggshield

#       - name: Run GitGuardian and handle result
#         env:
#           GITGUARDIAN_API_KEY: ${{ secrets.GG_API_KEY }}
#           GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#         run: |
#           echo "üîç Running GitGuardian secret scan..."
#           set -o pipefail

#           # Run the scan and save output + exit code
#           scan_output=$(mktemp)
#           if ! ggshield secret scan ci 2>&1 | tee "$scan_output"; then
#             echo "‚ùå GitGuardian scan failed - secrets detected."

#             # Extract PR number
#             pr_number="${{ github.event.pull_request.number }}"

#             # Format and escape comment body
#             comment_body=$(jq -Rs . < "$scan_output")

#             # Post a comment to the PR
#             curl -s -X POST \
#               -H "Authorization: token $GH_TOKEN" \
#               -H "Content-Type: application/json" \
#               -d "{\"body\": \"üö® **GitGuardian Secret Scan Failed**\n\n\`\`\`\n$comment_body\n\`\`\`\nPlease remove the detected secrets before merging.\"}" \
#               "https://api.github.com/repos/${{ github.repository }}/issues/${pr_number}/comments"

#             exit 1
#           else
#             echo "‚úÖ No secrets found."
#           fi

name: GitGuardian Secret Scan

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  secret-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install GitGuardian CLI
        run: pip install ggshield

      - name: Run GitGuardian and post PR comment if secrets found
        env:
          GITGUARDIAN_API_KEY: ${{ secrets.GG_API_KEY }}
          GH_PAT: ${{ secrets.GH_PAT }}
        run: |
          echo "üîç Running GitGuardian secret scan..."
          set +e
          output=$(ggshield secret scan ci 2>&1)
          exit_code=$?
          set -e

          echo "$output"

          if [ $exit_code -ne 0 ]; then
            echo "‚ùå GitGuardian scan failed - secrets detected."

            pr_number=$(jq --raw-output .pull_request.number "$GITHUB_EVENT_PATH")

            comment_body=$(echo "$output" | sed 's/"/\\"/g' | sed 's/$/\\n/' | tr -d '\n')
            curl -s -X POST \
              -H "Authorization: token $GH_PAT" \
              -H "Content-Type: application/json" \
              -d "{\"body\": \"üö® **GitGuardian Secret Scan Failed**\\n\\n\`\`\`\\n$output\\n\`\`\`\"}" \
              "https://api.github.com/repos/${{ github.repository }}/issues/${pr_number}/comments"

            exit 1
          fi


